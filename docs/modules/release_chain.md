# Module: Release Chain

**File:** `noktvrn_ai_artist/release_chain/release_chain.py`

## Purpose

The Release Chain module is responsible for the final stage of content processing within the AI Artist system. It takes an approved generation run (identified by its `run_id`), gathers all necessary assets (audio, video, cover art), generates structured metadata, organizes these into a standardized release directory, logs the release, and adds it to a queue for potential future publication or distribution.

This module acts as the bridge between the content generation and approval process (managed by the `artist_batch_runner`) and the final, packaged release output.

## Functionality

1.  **Input Processing:** Takes a `run_id` as input.
2.  **Status Verification:** Reads the corresponding `run_{run_id}.json` file from the `output/run_status/` directory (generated by the batch runner) and verifies that the status is "approved".
3.  **Directory Creation:** Creates a unique, structured directory for the release under `output/releases/` using the format `{artist_slug}_{YYYYMMDD}_{run_id_prefix}`.
4.  **Asset Gathering (Placeholders):**
    *   Downloads the generated audio track (using `download_asset` placeholder).
    *   Downloads the selected video (using `download_asset` placeholder).
    *   Generates cover art (using `generate_cover_art` placeholder).
    *   Saves these assets into the respective `audio/`, `video/`, and `cover/` subdirectories within the release directory.
5.  **Metadata Generation:**
    *   Analyzes the track structure (using `analyze_track_structure` placeholder).
    *   Retrieves prompts used during generation from the run data (using `get_prompts_from_run_data`).
    *   Populates `ReleaseMetadata` and `PromptsUsed` Pydantic models with information from the run data and generated assets/analysis.
6.  **Metadata Saving:** Saves the populated `ReleaseMetadata` and `PromptsUsed` models as `metadata.json` and `prompts_used.json` within the release directory.
7.  **Logging:** Appends a summary of the release (ID, artist, date, directory, etc.) to the central `output/release_log.md` file.
8.  **Queueing:** Adds an entry containing the release ID, artist name, and release directory path to the `output/release_queue.json` file.

## Configuration

The module can be configured using environment variables, typically defined in a `.env` file within the `release_chain` directory (`noktvrn_ai_artist/release_chain/.env`). An example file (`.env.example`) is provided.

*   `RELEASE_CHAIN_LOG_LEVEL`: Sets the logging level (e.g., `INFO`, `DEBUG`, `WARNING`). Defaults to `INFO`.
*   `OUTPUT_BASE_DIR`: Overrides the base output directory (defaults to `noktvrn_ai_artist/output`).
*   `RELEASES_DIR`: Overrides the releases directory path (defaults to `{OUTPUT_BASE_DIR}/releases`).
*   `RUN_STATUS_DIR`: Overrides the run status directory path (defaults to `{OUTPUT_BASE_DIR}/run_status`).
*   `RELEASE_LOG_FILE`: Overrides the path to the markdown log file (defaults to `{OUTPUT_BASE_DIR}/release_log.md`).
*   `RELEASE_QUEUE_FILE`: Overrides the path to the JSON queue file (defaults to `{OUTPUT_BASE_DIR}/release_queue.json`).

## Dependencies

*   **Internal:**
    *   `noktvrn_ai_artist/release_chain/schemas.py`: Defines the `ReleaseMetadata` and `PromptsUsed` Pydantic models.
    *   `noktvrn_ai_artist/output/run_status/run_{run_id}.json`: Input files generated by the `artist_batch_runner` containing details of an approved run.
*   **External Libraries:** `python-dotenv`, `pathlib`, `json`, `datetime`, `logging`, `threading`.

## Integration

The `release_chain.py` module is primarily intended to be called by the `artist_batch_runner.py` module.

*   The `artist_batch_runner` imports the `process_approved_run` function from `release_chain.py`.
*   After a run is confirmed as "approved" (via Telegram feedback or other mechanism), the batch runner calls `process_approved_run(run_id)` to initiate the release packaging process.

## Placeholders & Future Work

Currently, several key functions rely on placeholders:

*   `download_asset`: Needs to be implemented to actually download files from URLs (e.g., Suno audio, Pexels video).
*   `generate_cover_art`: Needs integration with an image generation model/service.
*   `analyze_track_structure`: Needs integration with an audio analysis library/service.
*   `get_prompts_from_run_data`: The cover prompt is currently a placeholder.
*   LLM Summary in `ReleaseMetadata`: Needs integration with an LLM to generate summaries.

Error handling for asset gathering failures could be enhanced (e.g., retry mechanisms, more specific error reporting).

## Usage (Direct)

While primarily designed for integration, the script can be run directly for testing purposes:

```bash
cd /path/to/noktvrn_ai_artist/release_chain
# Ensure a .env file exists or variables are set
# Create a dummy run_{test_run_id}.json file in ../output/run_status/
python3.11 release_chain.py
```

This will execute the `if __name__ == "__main__":` block, creating a dummy run status file and attempting to process it using `process_approved_run("test_direct_run")`.

